# Maintainer: Jaroslav Bolek <jarris@post.cz>
pkgname=lenovo-legion-linux-toolkit
pkgver=1.0.0
pkgrel=1
pkgdesc="Lenovo Legion Linux Toolkit - for lenovo legion laptops"
arch=("x86_64")
url="git+https://github.com/bolekjar/LenovoLegion.git"
license=('GPL3')
depends=("qt6-base" "qt6-5compat" "dkms" "make" "gcc" "qt6-charts" "protobuf" "cuda" "pkgconf")
source=("$pkgname-$pkgver::$url")
sha256sums=('SKIP')
install=default.install
qmake=qmake6

package() {

  #prepare directories
  mkdir -p $pkgdir/opt/$pkgname-$pkgver
  mkdir -p $pkgdir/usr/src/$pkgname-$pkgver
  mkdir -p $pkgdir/usr/lib/systemd/system/
  mkdir -p $pkgdir/etc/modprobe.d/
  mkdir -p $pkgdir/etc/modules-load.d/
  mkdir -p $pkgdir/usr/share/applications/
  mkdir -p $pkgdir/etc/udev/rules.d/


  ln -s $pkgname-$pkgver $pkgdir/opt/$pkgname

  #dms driver
  cp $srcdir/$pkgname-$pkgver/$pkgname-dkms/* $pkgdir/usr/src/$pkgname-$pkgver

  #settings
  cp $srcdir/$pkgname-$pkgver/$pkgname-dkms/blacklist-lenovo-legion.conf $pkgdir/etc/modprobe.d/
  cp $srcdir/$pkgname-$pkgver/$pkgname-dkms/lenovo-legion.conf $pkgdir/etc/modules-load.d/
  cp $srcdir/$pkgname-$pkgver/$pkgname-dkms/99-rapl-readonly.rules $pkgdir/etc/udev/rules.d
  cp $srcdir/$pkgname-$pkgver/$pkgname-dkms/rapl-readonly.sh $pkgdir/opt/$pkgname-$pkgver/
  chmod 755 $pkgdir/opt/$pkgname-$pkgver/rapl-readonly.sh

  #daemon, gui
  $qmake $srcdir/$pkgname-$pkgver/$pkgname/ -o $srcdir/$pkgname-$pkgver/$pkgname/Makefile
  make -C $srcdir/$pkgname-$pkgver/$pkgname/

  #daemon, gui, dkms
  cp -r $srcdir/$pkgname-$pkgver/$pkgname/Installation/* $pkgdir/opt/$pkgname-$pkgver
  chmod 777 $pkgdir/opt/$pkgname-$pkgver/log
  chmod 777 $pkgdir/opt/$pkgname-$pkgver/data

  #daemon setings
  cp $srcdir/$pkgname-$pkgver/$pkgname/$pkgname-Daemon/lenovo-legion-daemon.service $pkgdir/usr/lib/systemd/system/

  #kde menu entry
  cp $srcdir/$pkgname-$pkgver/$pkgname/$pkgname-Application/LenovoLegion.desktop $pkgdir/usr/share/applications/
}
